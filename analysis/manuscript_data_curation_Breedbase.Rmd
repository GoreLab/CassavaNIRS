---
title: "manuscript_data_curation_Breedbase"
author: "Jenna Hershberger"
date: "2021-04-19"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

## Introduction
### Load required packages and set palette
```{r packages}
library(tidyverse)
library(magrittr)
library(janitor)
library(readxl)
library(waves)

iwanthue <- c("#c84d4c","#c77c3f","#d19f32","#647e3a","#61b858","#4db5a4","#6585cc","#975fc7","#c575a1","#cf4391")
```

### Make dataset in Cassavabase and download from wizard (so get plot info even for trials without DM phenotypes)
### Trials include:

* 17.CASS.PYT.49.setA.IB
* 17.GS.C3.PYT.80.IB
* 18.CASS.PYT.52.IB
* 19.CMSSurveyVarieties.AYT.33.IB
* 19.GS.C2.UYT.36.setA.IB
* 19.GS.C2.UYT.36.setB.IB
* 18.GS.C2.setA.UYT.36.IB
* 18.GS.C2.setB.UYT.36.IB
* 19.CASS.PYT.52.IK
* 19.GS.C4B.PYT.500.IK

### Load in Cassavabase phenotype files
Note: Only one of the 2018 IITA trials has replicate 3, and that replicate has no spectral data. Can filter out all replicates > 2.

```{r read_plots}
colnames_to_keep <- c("studyYear", "programName", "studyName", "studyDesign", "plotWidth",
                      "plotLength", "plantingDate", "harvestDate", "MAP", "locationName",
                      "germplasmName", "observationLevel", "observationUnitName", "replicate",
                      "blockNumber", "plotNumber", "rowNumber", "colNumber", "entryType", "sample.prep",
                      "dry.matter.content.percentage.CO_334.0000092")

sliced_trials <- c("17.CASS.PYT.49.setA.IB", "17.GS.C3.PYT.80.IB", "18.CASS.PYT.52.IB")

# This file was downloaded from Cassavabase on 4/19/2021
pheno_plots <- read.csv("data/Cassavabase_phenotypes_20210419.csv",
                        stringsAsFactors = F, na = c("", "NA")) %>% 
  remove_empty("cols") %>% 
  mutate(sample.prep = case_when(
    studyName %in% sliced_trials ~ "Central",
    !studyName %in% sliced_trials ~ "Homogenized",
    TRUE ~ NA_character_
    )) %>% 
  mutate(MAP = NA,
         dry.matter.content.percentage.CO_334.0000092 = as.numeric(dry.matter.content.percentage.CO_334.0000092)) %>% 
  drop_na(dry.matter.content.percentage.CO_334.0000092) %>% 
  dplyr::select(all_of(colnames_to_keep))
```

## Load remaining row/column info from Prasad to fix Cassavabase errors
```{r}
fixed_row_col_names <- c("observationUnitName", "row_number", "col_number")

pheno_17.CASS.PYT.49.setA.IB <- read_excel("data/Corrected_metadata/17.CASS.PYT.49.setA.IB.xls") %>% 
  rename(observationUnitName = plot_name) %>% 
  mutate(observationUnitName = str_replace(.$observationUnitName, "s", "S")) %>% # new file has lowercase "s" in OUNs but BB has "S"
  dplyr::select(all_of(fixed_row_col_names))

pheno_17.GS.C3.PYT.80.IB <- read_excel("data/Corrected_metadata/17.GS.C3.PYT.80.IB.xls") %>% 
  rename(observationUnitName = plot_name) %>%
  dplyr::select(all_of(fixed_row_col_names))

pheno_19.CMSSurveyVarieties.AYT.33.IB <- read_excel("data/Corrected_metadata/19.GS.C1.C2.AYT.33.IB_Row_Col.xls") %>% 
  rename(observationUnitName = plot_name) %>% 
  dplyr::select(all_of(fixed_row_col_names))

pheno_19.CASS.PYT.52.IK <- read_excel("data/Corrected_metadata/19.CASS.PYT.52.IK_Row_Col.xls") %>% 
    rename(observationUnitName = plot_name) %>% 
  dplyr::select(all_of(fixed_row_col_names))

pheno_fixed_row_col <- rbind(pheno_17.CASS.PYT.49.setA.IB, pheno_17.GS.C3.PYT.80.IB,
                             pheno_19.CMSSurveyVarieties.AYT.33.IB, pheno_19.CASS.PYT.52.IK)
```

## Join phenotype dataset with fixed row/column data
```{r}
pheno <- pheno_plots %>% 
  full_join(., pheno_fixed_row_col, by = c("observationUnitName")) %>%
  mutate(rowNumber = ifelse(is.na(row_number), rowNumber, row_number)) %>% 
  mutate(colNumber = ifelse(is.na(col_number), colNumber, col_number)) %>%
  dplyr::select(-row_number, -col_number) %>% 
  drop_na(studyName) %>% 
  distinct()

pheno$plantingDate <- as.character(pheno$plantingDate)
pheno$harvestDate <- as.character(pheno$harvestDate)

pheno <- pheno %>% mutate_if(is.character, list(~na_if(.,""))) %>% 
  mutate_if(is.character, list(~na_if(.,"NA")))

# DMC histograms to check
pheno %>% 
    ggplot(.,aes(x = dry.matter.content.percentage.CO_334.0000092, fill = studyName)) + 
    facet_wrap(~ studyName) + 
    geom_histogram() +
    theme_bw() + theme(legend.position = "none")

# boxplots/violins
pheno %>%
  ggplot(aes(x = studyName, 
             y = dry.matter.content.percentage.CO_334.0000092, 
             fill = studyName)) + 
  geom_violin() +
  geom_boxplot(position = "identity", width = .2) + 
  theme_bw() + 
  labs(title = "Plot mean dry matter content by trial", 
       x = element_blank(),
       y = "Dry matter content (%)") +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), legend.position = "bottom")

pheno %>% 
  group_by(programName) %>% 
  summarize(min_dmc = min(dry.matter.content.percentage.CO_334.0000092, na.rm = T),
            max_dmc = max(dry.matter.content.percentage.CO_334.0000092, na.rm = T))

# minimum DMC is 9.75
# maximum is 47.1
```

```{r}
write.csv(pheno, "output/curated_pheno.csv", row.names = F)
```


# SCANS
```{r}
# for spectra that match using plot numbers (IITA)
scan_colnames_plots <- c("studyName", "plotNumber", "rootNumber", "subsample", "scanTimestamp", 
                         "device_id", "comments")
```

## PYT80
```{r}
# These don't map 1:1 with DMC. There is an extra 0 in the DMC dataset example: scan 108 = DMC 1008, scan 290 = DMC 2090
scans_17.GS.C3.PYT.80.IB <- read.csv("data/Spectra/2017.IITA.GS.C3.PYT80_spectra.csv") %>% 
  mutate(studyName = "17.GS.C3.PYT.80.IB",
         comments = NA,
         subsample = NA,
         plotNumber = if_else(plot_no < 200, plot_no + 900, plot_no + 1800)) %>% # Fix plot numbers
  rename(rootNumber = root_no,
         scanTimestamp = sampling_time) %>% 
  dplyr::select(all_of(scan_colnames_plots), starts_with("spectrum"))

colnames(scans_17.GS.C3.PYT.80.IB)[8:ncol(scans_17.GS.C3.PYT.80.IB)] <- paste0("X", 740:1070)
```

## PYT49
```{r}
scans_17.CASS.PYT.49.setA.IB_rep1 <- read.csv("data/Spectra/2017.IITA.GS.C0.PYT49.IBA.REP1_spectra.csv") %>% 
  mutate(plot_number = plot_no + 900) %>% # Correct so matches DMC (1001 vs 101)
  rename(root_number = root_no) %>% 
  dplyr::select(id:sampling_time, plot_number, root_number, everything(), -plot_no)
scans_17.CASS.PYT.49.setA.IB_rep2 <- read.csv("data/Spectra/CBU.IITA.GS.PYT49.IB.Rep2_spectra.csv")
scans_17.CASS.PYT.49.setA.IB <- rbind(scans_17.CASS.PYT.49.setA.IB_rep1, scans_17.CASS.PYT.49.setA.IB_rep2) %>% 
  mutate(studyName = "17.CASS.PYT.49.setA.IB", 
         comments = NA, 
         subsample = NA) %>% 
  rename(plotNumber = plot_number,
         rootNumber = root_number, 
         scanTimestamp = sampling_time) %>% 
  dplyr::select(all_of(scan_colnames_plots), starts_with("spectrum"))

colnames(scans_17.CASS.PYT.49.setA.IB)[8:ncol(scans_17.CASS.PYT.49.setA.IB)] <- paste0("X", 740:1070)
```

## 18.CASS.PYT.52.IB
```{r}
scans_18.CASS.PYT.52.IB <- read.csv("data/Spectra/IITA.18.Cass.PYT52.Ibadan.csv") %>% 
  mutate(studyName = "18.CASS.PYT.52.IB",
         comments = NA,
         subsample = NA) %>% 
  # Plot numbers messed up for PYT52 so all scans are associated with plots 100-300, which don't actually exist.
  # Change to - 900 or - 1800
  mutate(plotNumber = ifelse(plot_number < 2000, plot_number - 900, plot_number - 1800)) %>% 
  rename(rootNumber = root_number,
         scanTimestamp = sampling_time) %>% 
  dplyr::select(all_of(scan_colnames_plots), starts_with("spectrum")) 

colnames(scans_18.CASS.PYT.52.IB)[8:ncol(scans_18.CASS.PYT.52.IB)] <- paste0("X", 740:1070)
```

## Early batch of 2020 trials
Half of the file was off by a column -- incorrectly cut and pasted.
```{r load_early_2020_scans}
header_early <- read.csv("data/Spectra/SCiO_2020_1.csv", 
                         skip = 10, nrows = 1, header = F) %>% t()
raw_early <- read.csv("data/Spectra/SCiO_2020_1.csv", 
                      skip = 12, na.strings = "", stringsAsFactors = F)
colnames(raw_early) <- header_early

scans_early <- raw_early %>% 
  rename(subsample = Scan_number, studyName = Trial, plotNumber = Plot_number,
         frame_type = `Frame type`, sample_name = sample_number,
         scanTimestamp = sampling_time) %>% 
  mutate(frame_type = replace_na(frame_type, "normal scan")) %>% 
  mutate(frame_type = recode(frame_type, 
                             "open scan without frame" = "no_frame",
                             "normal scan" = "frame"),
         comments = NA,
         rootNumber = NA) %>% 
  filter(frame_type == "frame") %>% 
  dplyr::select(all_of(scan_colnames_plots), starts_with("spectrum_")) 

colnames(scans_early)[8:ncol(scans_early)] <- paste0("X", 740:1070)

#hist(scans_2020_early$subsample) 
# when frame_type == no_frame, subsample == 1 always, so there are double the number of subsample == 1 as all other subsample numbers. 
# Some trials have 6 subsamples, some have 10, hence the dropped numbers for subsamples > 6
```

### Trial names are listed differently in these files:
18.GS.C2.setA.UYT.36.IB  == IITA.18.GS.C1.C2.UYT36.SET_A.IB
18.GS.C2.setB.UYT.36.IB ==  IITA.18.GS.C1.C2.UYT36.set-B.IB
19.CASS.PYT.52.IK == IITA.19.CASS.PYT.52.IK
19.CMSSurveyVarieties.AYT33.IK == IITA.19.CMSSURVEYVARIETIES.AYT33.IK
19.GS.C4B.PYT.500.IK == 19.IITA.GS.C4B.CASS.PYT500.IK

```{r load_remaining_iita_scans}
# 18.GS.C2.setA.UYT.36.IB
header_18.GS.C2.setA.UYT.36.IB <- read.csv("data/Spectra/raw_spectra_18.GS.C2.setA.UYT.36.IB.csv", 
                                           skip = 10, nrows = 1, header = F) %>% t()
rawscans_18.GS.C2.setA.UYT.36.IB <- read.csv("data/Spectra/raw_spectra_18.GS.C2.setA.UYT.36.IB.csv", 
                                             skip = 12, na.strings = "")
colnames(rawscans_18.GS.C2.setA.UYT.36.IB) <- header_18.GS.C2.setA.UYT.36.IB

scans_18.GS.C2.setA.UYT.36.IB <- rawscans_18.GS.C2.setA.UYT.36.IB %>% 
  dplyr::select(id:location, starts_with("spectrum_")) %>%
  mutate(studyName = "18.GS.C2.setA.UYT.36.IB",
         comments = NA,
         rootNumber = NA) %>% 
  rename(plotNumber = Plot_number, 
         subsample = scan_number,
         scanTimestamp = sampling_time) %>% 
  dplyr::select(all_of(scan_colnames_plots), starts_with("spectrum_"))
  
colnames(scans_18.GS.C2.setA.UYT.36.IB)[8:ncol(scans_18.GS.C2.setA.UYT.36.IB)] <- paste0("X", 740:1070)

# 18.GS.C2.setB.UYT.36.IB
header_18.GS.C2.setB.UYT.36.IB <- read.csv("data/Spectra/raw_spectra_18.GS.C2.setB.UYT.36.IB.csv", 
                                           skip = 10, nrows = 1, header = F) %>% t()
rawscans_18.GS.C2.setB.UYT.36.IB <- read.csv("data/Spectra/raw_spectra_18.GS.C2.setB.UYT.36.IB.csv", 
                                             skip = 12, na.strings = "")
colnames(rawscans_18.GS.C2.setB.UYT.36.IB) <- header_18.GS.C2.setB.UYT.36.IB

scans_18.GS.C2.setB.UYT.36.IB <- rawscans_18.GS.C2.setB.UYT.36.IB %>% 
  dplyr::select(id:location, starts_with("spectrum_")) %>%
  mutate(studyName = "18.GS.C2.setB.UYT.36.IB",
         comments = NA,
         rootNumber = NA) %>% 
  rename(subsample = serial_number, 
         plotNumber = plot_number, 
         scanTimestamp = sampling_time) %>% 
  dplyr::select(all_of(scan_colnames_plots), starts_with("spectrum_"))
  
colnames(scans_18.GS.C2.setB.UYT.36.IB)[8:ncol(scans_18.GS.C2.setB.UYT.36.IB)] <- paste0("X", 740:1070)

# 19.CASS.PYT.52.IK
# 19.CASS.PYT.52.IK spectra plots have extra 0 -- 101 in CB is 1001 in scans
header_19.CASS.PYT.52.IK <- read.csv("data/Spectra/raw_spectra_19.CASS.PYT.52.IK.csv", 
                                     skip = 10, nrows = 1, header = F) %>% t()
rawscans_19.CASS.PYT.52.IK <- read.csv("data/Spectra/raw_spectra_19.CASS.PYT.52.IK.csv", 
                                       skip = 12, na.strings = "")
colnames(rawscans_19.CASS.PYT.52.IK) <- header_19.CASS.PYT.52.IK

scans_19.CASS.PYT.52.IK <- rawscans_19.CASS.PYT.52.IK %>% 
  dplyr::select(id:location, starts_with("spectrum_")) %>%
  mutate(studyName = "19.CASS.PYT.52.IK",
         comments = NA,
         rootNumber = NA,
         plotNumber = ifelse(PLOT_NO < 2000, PLOT_NO - 900, PLOT_NO - 1800)) %>% 
  rename(subsample = SCAN_NO,
         scanTimestamp = sampling_time) %>% 
  dplyr::select(all_of(scan_colnames_plots), starts_with("spectrum_"))
  
colnames(scans_19.CASS.PYT.52.IK)[8:ncol(scans_19.CASS.PYT.52.IK)] <- paste0("X", 740:1070)

# 19.GS.C4B.PYT.500.IK
header_19.GS.C4B.PYT.500.IK <- read.csv("data/Spectra/raw_spectra_19.GS.C4B.PYT.500.IK.csv", 
                                              skip = 10, nrows = 1, header = F) %>% t()
rawscans_19.GS.C4B.PYT.500.IK <- read.csv("data/Spectra/raw_spectra_19.GS.C4B.PYT.500.IK.csv", skip = 12, na.strings = "")
colnames(rawscans_19.GS.C4B.PYT.500.IK) <- header_19.GS.C4B.PYT.500.IK

scans_19.GS.C4B.PYT.500.IK <- rawscans_19.GS.C4B.PYT.500.IK %>% 
  dplyr::select(id:location, starts_with("spectrum_")) %>%
  mutate(studyName = "19.GS.C4B.PYT.500.IK",
         comments = NA,
         rootNumber = NA) %>% 
  rename(plotNumber = Plot_number, 
         subsample = `Scan _number`,
         scanTimestamp = sampling_time) %>% 
  dplyr::select(all_of(scan_colnames_plots), starts_with("spectrum_"))
  
colnames(scans_19.GS.C4B.PYT.500.IK)[8:ncol(scans_19.GS.C4B.PYT.500.IK)] <- paste0("X", 740:1070)
```


## rbind scans
```{r rbind_scans}
scans_all <- rbind(scans_17.CASS.PYT.49.setA.IB, scans_17.GS.C3.PYT.80.IB, scans_18.CASS.PYT.52.IB, 
                        scans_early, scans_18.GS.C2.setA.UYT.36.IB, scans_18.GS.C2.setB.UYT.36.IB,
                        scans_19.CASS.PYT.52.IK, scans_19.GS.C4B.PYT.500.IK) %>% 
  drop_na(X740) %>% 
  rownames_to_column() # assign unique ids for filtering

# clear memory of large objects
remove(rawscans_18.GS.C2.setA.UYT.36.IB, rawscans_18.GS.C2.setB.UYT.36.IB, rawscans_19.CASS.PYT.52.IK, 
       rawscans_19.GS.C4B.PYT.500.IK, raw_early, scans_17.CASS.PYT.49.setA.IB_rep1, 
       scans_17.CASS.PYT.49.setA.IB_rep2, scans_17.CASS.PYT.49.setA.IB, scans_17.GS.C3.PYT.80.IB, 
       scans_18.CASS.PYT.52.IB, scans_early, scans_18.GS.C2.setA.UYT.36.IB, scans_18.GS.C2.setB.UYT.36.IB, 
       scans_19.CASS.PYT.52.IK, scans_19.GS.C4B.PYT.500.IK, header_18.GS.C2.setA.UYT.36.IB, 
       header_18.GS.C2.setB.UYT.36.IB, header_19.CASS.PYT.52.IK, header_19.GS.C4B.PYT.500.IK, header_early)

write.csv(scans_all, "output/scans_all_unfiltered.csv", row.names = FALSE)
```

```{r set_new_column_names}
joined_colnames <- c(colnames_to_keep, "rootNumber", "subsample", "scanTimestamp", 
                     "device_id", "comments", paste0("X", 740:1070))

joined_colnames_no_subsample <- c(colnames_to_keep, "scanTimestamp", 
                     "device_id", "comments", paste0("X", 740:1070))
```

Filter and join IITA datasets
```{r}
scans_all$X740 <- as.numeric(scans_all$X740)
scans_filtered <- scans_all %>% 
  # have to remove columns with missing values before FilterSpectra() because of waves requirement
  dplyr::select(rowname, starts_with("X")) %>% 
  FilterSpectra(filter = TRUE,
                return.distances = FALSE, 
                num.col.before.spectra = 1,
                window.size = 10) %>% 
  left_join(x = ., y = scans_all[,1:8], by = "rowname") %>% 
  mutate(subsample = ifelse(is.na(subsample), rootNumber, subsample)) %>% 
  dplyr::select(all_of(scan_colnames_plots), starts_with("X")) %>% 
  distinct()

scans_removed_df <- scans_all %>% 
  # have to remove columns with missing values before FilterSpectra() because of waves requirement
  dplyr::select(rowname, starts_with("X")) %>% 
  FilterSpectra(filter = FALSE,
                return.distances = TRUE, 
                num.col.before.spectra = 1,
                window.size = 10) %>% 
  left_join(x = ., y = scans_all[,1:8], by = "rowname") %>% 
  mutate(subsample = ifelse(is.na(subsample), rootNumber, subsample)) %>% 
  dplyr::select(all_of(scan_colnames_plots), h.distances, starts_with("X"), -comments) %>% 
  filter(h.distances > 300) %>%
  rename(Mahalanobis.distance = h.distances) %>% 
  arrange(-Mahalanobis.distance) %>% 
  distinct()
write.csv(scans_removed_df, "output/manuscript/S3_removed_scans.csv", row.names = F)

scans_filtered_subsample <- scans_filtered %>%
  # AggregateSpectra() requires a column named "reference"
  mutate(reference = 1) %>%
  drop_na(subsample) %>% 
  # have to remove columns with missing values before AggregateSpectra() because of waves requirement
  dplyr::select(studyName, plotNumber, subsample, reference, starts_with("X")) %>% 
  AggregateSpectra(grouping.colnames = c("studyName", "plotNumber", "subsample"),
                   reference.value.colname = "reference", agg.function = "mean") %>%
  dplyr::select(-reference) %>% 
  left_join(x = ., y = scans_filtered[1:7], by = c("studyName", "plotNumber", "subsample")) %>% 
  dplyr::select(all_of(scan_colnames_plots), starts_with("X")) %>% 
  distinct()

scans_filtered_plots <- scans_filtered %>%
  # AggregateSpectra() requires a column named "reference"
  mutate(reference = 1) %>%
  drop_na(plotNumber) %>% 
  # have to remove columns with missing values before AggregateSpectra() because of waves requirement
  dplyr::select(studyName, plotNumber, reference, starts_with("X")) %>% 
  AggregateSpectra(grouping.colnames = c("studyName", "plotNumber"),
                   reference.value.colname = "reference", agg.function = "mean") %>%
  dplyr::select(-reference) %>% 
  # join only with the relevant metadata from scans_filtered (studyName, plotNumber, scanTimestamp, device_id, comments)
  left_join(x = ., y = scans_filtered[c(1,2,5,6,7)], by = c("studyName", "plotNumber")) %>% 
  dplyr::select(all_of(scan_colnames_plots[c(1,2,5,6,7)]), starts_with("X")) %>% 
  distinct()

full_filtered <- pheno %>% 
  full_join(scans_filtered, by = c("studyName", "plotNumber")) %>% 
  dplyr::select(all_of(joined_colnames)) %>% 
  drop_na(dry.matter.content.percentage.CO_334.0000092, X740) %>%  # comment this line out to get counts of missingness
  distinct()

full_subsamples <- pheno %>% 
  full_join(scans_filtered_subsample, by = c("studyName", "plotNumber")) %>% 
  dplyr::select(all_of(joined_colnames)) %>% 
  drop_na(dry.matter.content.percentage.CO_334.0000092, X740) %>% 
  distinct()

full_plots <- pheno %>% filter(programName == "IITA") %>% 
  full_join(scans_filtered_plots, by = c("studyName", "plotNumber")) %>% 
  dplyr::select(all_of(joined_colnames_no_subsample)) %>% 
  drop_na(dry.matter.content.percentage.CO_334.0000092, X740) %>% 
  distinct()

nrow(full_filtered)
nrow(full_subsamples)
nrow(full_plots)

# save
write.csv(full_filtered, "output/full_filtered_unaggregated.csv", row.names = F)
write.csv(full_subsamples, "output/full_filtered_subsamples.csv", row.names = F)
write.csv(full_plots, "output/full_filtered_plots.csv", row.names = F)
```
